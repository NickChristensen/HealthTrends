{"id":"HT-0kv","title":"DevTools: Display authorization check values causing \"Request Health Permissions\" button","description":"## Problem\n\nThe \"Request Health Permissions\" button is showing up erroneously. We need visibility into the values being checked to determine when to show this button.\n\n## Requested Feature\n\nAdd a debug panel in Development Tools that displays:\n\n1. **Authorization check values** that control the \"Request Health Permissions\" button visibility\n2. **Cache state** (TodayEnergyCache exists? Age? Contents?)\n3. **HealthKit authorization status** (actual value from HealthKit API)\n4. **Any other flags/conditions** that influence whether the button appears\n\n## Why This Matters\n\n- Button appears when it shouldn't → frustrating user experience\n- No visibility into WHY the button is showing → hard to debug\n- Need to see the actual check values to identify logic errors\n\n## Expected Outcome\n\nDevelopment Tools sheet includes a section showing:\n- Each condition checked for showing \"Request Health Permissions\"\n- Current value of each condition (true/false, timestamps, etc.)\n- Clear indication of which condition(s) are triggering the button to appear\n\n## Files Likely Involved\n\n- `HealthTrends/Views/App/DevelopmentToolsSheet.swift` - Add debug display\n- `HealthTrends/Views/App/ContentView.swift` - Check what conditions show the button\n- `HealthTrends/Managers/HealthKitManager.swift` - Authorization state checks","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T23:43:35.765279-06:00","updated_at":"2025-12-18T00:11:39.867209-06:00","closed_at":"2025-12-18T00:11:39.867216-06:00","external_ref":"https://github.com/NickChristensen/HealthTrends/pull/54","comments":[{"id":1,"issue_id":"HT-0kv","author":"nick","text":"Undoing merge to create PR for code review","created_at":"2025-12-18T06:07:27Z"}]}
{"id":"HT-1","title":"Rework ContentView from dev tool to user-friendly experience","description":"ContentView currently shows widget previews and dev tools, which isn't user-friendly. Need to redesign for actual users.\n\n## Current issues\n- Widget preview containers are developer-focused, not useful for end users\n- Health permissions are requested automatically without explanation\n- No onboarding or explanation of what the app does\n\n## Proposed improvements\n- Remove everything from ContentView except for the devtools button + sheet, and the shake gesture\n- Change ContentView to a single screen screen that:\n  - Explains WHY we need Health data access\n  - Has a clear \"Grant Health Access\" button instead of automatic request\n\n---\n_Migrated from beads issue ht-ftf_","status":"closed","priority":2,"issue_type":"feature","assignee":"NickChristensen","created_at":"2025-11-16T17:46:37Z","updated_at":"2025-12-01T03:51:09Z","closed_at":"2025-12-01T03:51:09Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/1"}
{"id":"HT-10","title":"Missing stat for Average","description":"![image](https://github.com/user-attachments/assets/1c5b6da4-6ed1-4f06-8016-8e8fdf5dd748)\n\nProbably related to refactor in HT-7","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-24T05:29:20Z","updated_at":"2025-12-15T13:16:09.104605-06:00","closed_at":"2025-11-24T18:37:20Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/10"}
{"id":"HT-11","title":"Tap to refresh widget","description":"Change widget tap action to refresh data instead of open app. [Peak](https://apps.apple.com/us/app/peak-fitness-widgets/id6443923491) does this somehow.","status":"closed","priority":2,"issue_type":"feature","assignee":"NickChristensen","created_at":"2025-11-24T18:50:22Z","updated_at":"2025-11-30T06:43:22Z","closed_at":"2025-11-30T06:43:22Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/11"}
{"id":"HT-12","title":"Today `LineMark` still incorrect in widget","description":"It seems there is a scenario where the widget is refreshed but Today's active energy data isn't refreshed. In HT-7, we refactored data caching and loading– we decided that the \"Today\" data should be queried from HealthKit *every* time.\n\nSee screenshot:\n\u003cimg width=\"358\" height=\"364\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/52da9213-eb94-4f07-bff4-00ae44077581\" /\u003e\n\nNote the time at bottom: 2:36 PM. It looks like the data for today was last updated around 11:30am. The PointMark x-axis is correct because it's using the current time (as of render), not the most recent time for which we have data.\n\nAverage lines appear to be correct, caching and interpolation for current hour seems to be working correctly.","status":"closed","priority":2,"issue_type":"bug","assignee":"NickChristensen","created_at":"2025-11-25T21:00:37Z","updated_at":"2025-12-15T13:19:56.443141-06:00","closed_at":"2025-11-28T22:56:59Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/12"}
{"id":"HT-12g","title":"Add missing test coverage for widget entry creation paths","description":"## Context\n\nCode coverage audit (HT-9y8) revealed that current tests only exercise the **HealthKit success path** (100% coverage of PRD scenarios) but miss all **error recovery and cache fallback paths** (0% coverage).\n\n**Current Coverage:** 24.97% of DailyActiveEnergyWidget.swift (212/849 lines)\n**Target Coverage:** ~60-70% by adding recommended tests\n\nSee HT-9y8 comments for detailed audit findings.\n\n## Tests to Add\n\n### HIGH Priority: Cache Fallback Tests\n\nCreate `Scenario5_CacheFallbackTests.swift`:\n\n**Test 1: Today's Cache Fallback**\n- GIVEN: Valid today cache exists in shared container\n- WHEN: HealthKit query throws error (e.g., device locked)\n- THEN: Entry uses cached today data + cached average\n- Validates: Path #4 (lines 414-426)\n\n**Test 2: Yesterday's Cache Fallback (Stale)**\n- GIVEN: Cache from previous day exists\n- WHEN: HealthKit query fails\n- THEN: Entry shows average-only (no today line)\n- Validates: Path #5 (lines 438-448)\n\n**Test 3: Device Locked Scenario**\n- GIVEN: Cache exists\n- WHEN: HealthKit throws HKError.errorDatabaseInaccessible\n- THEN: Widget displays using cache (resilient to locked device)\n\n### MEDIUM Priority: Error Handling Tests\n\nCreate `Scenario6_ErrorHandlingTests.swift`:\n\n**Test 4: No Cache (Unauthorized)**\n- GIVEN: No cache file exists\n- WHEN: HealthKit query fails\n- THEN: Entry with isAuthorized=false, all zeros\n- Validates: Path #6 (lines 454-464)\n\n**Test 5: Container Not Found**\n- GIVEN: App group container misconfigured\n- WHEN: Cache read attempts container access\n- THEN: Entry with error state\n- Validates: Path #7 (lines 469-479)\n\n**Test 6: Cache Corruption**\n- GIVEN: Cache file exists but has invalid JSON\n- WHEN: Cache read throws DecodingError\n- THEN: Entry with fallback state\n- Validates: Path #8 (lines 486-496)\n\n**Test 7: Unexpected Cache Error**\n- GIVEN: Any other cache error\n- WHEN: Cache read throws unknown error\n- THEN: Entry with safe fallback\n- Validates: Path #9 (lines 502-512)\n\n### MEDIUM Priority: Midnight Entry Test\n\nAdd to existing test suite or create new file:\n\n**Test 8: Midnight Entry Creation**\n- GIVEN: Timeline requests entry for 00:00:00\n- WHEN: createMidnightEntry() is called\n- THEN: Entry has todayTotal=0, new weekday's average loaded\n- Validates: Path #2 (lines 249-280)\n\n**Test 9: Average Query Failed, No Fallback**\n- GIVEN: Today query succeeds\n- WHEN: Average query fails AND no stale cache exists\n- THEN: Entry shows today-only (no average line/projection)\n- Validates: Path #10 (lines 584-594)\n\n## Implementation Requirements\n\n### Mock Service Updates\n\nUpdate `MockHealthKitQueryService` to support error injection:\n\n```swift\nclass MockHealthKitQueryService: HealthKitQueryServiceProtocol {\n    var shouldThrowError: Bool = false\n    var errorToThrow: Error?\n    \n    func fetchTodayHourlyTotals() async throws -\u003e ([HourlyEnergyData], Date?) {\n        if shouldThrowError {\n            throw errorToThrow ?? HKError(.errorAuthorizationDenied)\n        }\n        return (configureSamples, configuredTimestamp)\n    }\n    \n    func fetchAverageData(for date: Date?) async throws -\u003e (Double, [HourlyEnergyData]) {\n        if shouldThrowError {\n            throw errorToThrow ?? HKError(.errorAuthorizationDenied)\n        }\n        return (configuredTotal, configuredAverageData)\n    }\n}\n```\n\n### Cache Manager Mocks\n\nMay need to create mock cache managers that can simulate:\n- File not found errors\n- Container not found errors\n- Decoding errors\n- Pre-populated cache data\n\n## Success Criteria\n\n- [ ] All 9 tests written and passing\n- [ ] Code coverage increases from 25% to 60-70%\n- [ ] All untested critical paths (#4, #5, #2) now covered\n- [ ] All error paths (#6-#10) validated\n- [ ] Test fixtures follow deterministic pattern (no randomness)\n- [ ] Tests use exact assertions (no ranges)\n- [ ] Tests documented in HealthTrendsWidgetTests/README.md\n\n## Files to Modify\n\n- `HealthTrendsWidgetTests/Mocks/MockHealthKitQueryService.swift` - Add error injection\n- `HealthTrendsWidgetTests/Scenarios/Scenario5_CacheFallbackTests.swift` - NEW\n- `HealthTrendsWidgetTests/Scenarios/Scenario6_ErrorHandlingTests.swift` - NEW\n- `HealthTrendsWidgetTests/README.md` - Document new test scenarios\n- Possibly new mock cache managers in `HealthTrendsWidgetTests/Mocks/`\n\n## Notes\n\n- LOW priority tests (widget gallery, placeholder) deliberately excluded - not worth the effort\n- Focus is on real-world failure modes that existing code handles but we've never verified\n- These paths exist specifically for resilience - important to validate they work","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T09:26:06.387787-06:00","updated_at":"2025-12-20T13:25:27.533712-06:00","closed_at":"2025-12-20T13:25:27.533712-06:00","close_reason":"Completed: Added 5 new tests covering cache fallback, error handling, and today-only edge cases. All tests passing.","dependencies":[{"issue_id":"HT-12g","depends_on_id":"HT-9y8","type":"discovered-from","created_at":"2025-12-20T09:26:06.389852-06:00","created_by":"daemon","metadata":"{}"},{"issue_id":"HT-12g","depends_on_id":"HT-wz9","type":"blocks","created_at":"2025-12-20T09:33:37.646515-06:00","created_by":"daemon","metadata":"{}"}]}
{"id":"HT-13","title":"Add informative empty state to widget when HealthKit authorization missing","description":"## Problem\nWhen a user adds the widget to their home screen without opening the app first, the widget shows placeholder data because it cannot request HealthKit authorization on its own.\n\n## Current Behavior\n- Widget queries HealthKit directly (has proper entitlements)\n- If no authorization granted, falls back to empty shared container\n- Shows generic placeholder data with no guidance\n\n## Proposed Solution\nAdd a clear empty state that guides users to open the app:\n\n\nWelcome to Swift!\n\nSubcommands:\n\n  swift build      Build Swift packages\n  swift package    Create and work on packages\n  swift run        Run a program from a package\n  swift test       Run package tests\n  swift repl       Experiment with Swift code interactively\n\n  Use `swift --version` for Swift version information.\n\n  Use `swift --help` for descriptions of available options and flags.\n\n  Use `swift help \u003csubcommand\u003e` for more information about a subcommand.\n\n## Technical Details\n- Widget cannot present authorization UI (extension limitation)\n- Once app grants authorization, widget automatically works\n- Widget refreshes every 15 minutes via timeline provider\n\n## Related\nRelated to HT-1 (onboarding flow) - both about improving first-time user experience\n\n## Acceptance Criteria\n- [ ] Widget shows clear message when no data available\n- [ ] Message explains user needs to open app\n- [ ] Tapping widget opens app (widgetURL or Link)\n- [ ] Empty state matches app's visual design, with an SF symbol that represents granting health access. The symbol could be related to health, privacy, permission, or settings\n- [ ] Works for both medium and large widget sizes","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-30T05:08:49Z","updated_at":"2025-12-15T13:16:09.04384-06:00","closed_at":"2025-12-01T17:41:16Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/13"}
{"id":"HT-14","title":"Investigate placeholder widget renders","description":"~~I'm still seeing behavior where the widget is updated but the activity data is stale. I know the widget is re-rendering, because the now time is relatively recent, but sometimes the activity data is hours out of date.~~\n\n~~A thought worth investigating: is it possible that there's a scenario where we successfully pull health kit data, but the health kit data itself is stale? We should add some checks and logs for this.~~\n\nUpdate: Since we\n- HT-13 added an empty state for widgets (expected to only show when HealthKit access hasn't been granted) \n- HT-15 added checks for HealthKit access with some assumptions based on a non-empty simple query\n\nI've been seeing the empty state very frequently, even though the app is definitely authorized. This is now what we need to investigate (the current logging may or may not still be helpful)","status":"closed","priority":2,"issue_type":"bug","assignee":"NickChristensen","created_at":"2025-11-30T18:19:41Z","updated_at":"2025-12-15T13:19:56.378962-06:00","closed_at":"2025-12-06T02:57:12Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/14"}
{"id":"HT-15","title":"adjust health kit permissions requests","description":"Two related improvements:\n\n1. In our main permissions request, we should remove the request for write access. Move the write access request to the action that generates mock data and request it then.\n\n2. Also in our main permissions request, we are setting a bit that tracks permission granted. Especially where we normally will not need write access, and as far as I understand, health kit will not let us know if permission was granted or not for read only, we need to change how we're tracking if access was granted. Could we do a very simple, fast, inexpensive query for active energy and assume that it was not granted if we get back some falsey value like 0, nil, etc?","status":"closed","priority":2,"issue_type":"task","assignee":"NickChristensen","created_at":"2025-11-30T22:11:24Z","updated_at":"2025-12-01T00:22:42Z","closed_at":"2025-12-01T00:22:42Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/16"}
{"id":"HT-16","title":"Add iPad compatibility","description":"## Description\nAdd iPad support to HealthTrends widgets to provide a better experience on larger screens.\n\n## Requirements\n- Enable native support for iPad instead of iPhone app on iPad\n- Support iPad-specific widget layouts for the existing medium and large sizes\n- Optimize widget UI for iPad home screen\n- Ensure charts and visualizations scale appropriately in widgets\n- Test across different iPad models (iPad mini, iPad Pro, etc.)\n\n## Technical Considerations\n- Update supported device families in project settings (widgetExtension target)\n- Widget size classes differ on iPad vs iPhone\n- Consider larger widget families available on iPad\n- Test any hardcoded dimensions or device-specific assumptions in widget code\n\n## Scope\n**Widgets only** - App views don't need iPad-specific work at this time, let's see how our SwiftUI layout adapts first.\n\n## Acceptance Criteria\n- [ ] Widget builds and runs on iPad simulators\n- [ ] Widget displays correctly on iPad home screen\n- [ ] Charts are readable and well-proportioned on iPad widgets\n- [ ] All widget sizes (medium/large) work properly on iPad","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-30T22:36:30Z","updated_at":"2025-12-06T03:35:13Z","closed_at":"2025-12-06T03:35:13Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/17"}
{"id":"HT-17","title":"Refactor app architecture: simplify app now that widget UI is separated","description":"## Context\n\n**Historical Evolution:**\n- Initially: App had simulated widget UI in ContentView for quick iteration during development\n- MVP phase: Created actual widget extension, moved code to shared locations (HealthKit access, permissions, widget updates)\n- Issue HT-1: Removed simulated widget UI from app entirely\n\n**Current State:**\n- App exists primarily to grant HealthKit access and authorization\n- All HealthKit queries, data processing, and UI **should** now live exclusively in the widget\n- The app only needs access to the cache -- it should use the same heuristic as the widget to determine HealthKit access (does cache exist essentially)\n- Shared code exists that was necessary when app had widget UI, but may no longer be needed\n\n**Future State:**\n- Multiple widgets planned that will use HealthKit data\n- Shared HealthKit access/authorization logic will still be necessary across widgets\n\n## Refactor Goals\n\n1. **Simplify app target:** Remove unnecessary code now that app is authorization-only\n2. **Consolidate widget logic:** Move widget-specific code out of shared locations if not needed by future widgets\n3. **Keep shared HealthKit core:** Maintain shared authorization, permissions, and base query logic for multiple future widgets\n4. **Clean architecture:** Clear separation between app (authorization), shared (multi-widget HealthKit), and widget (specific implementations)\n\n## Areas to Review\n\n- : Is this still needed in app, or can it be simplified?\n- : Still needed for app-widget communication?\n- : Should remain shared for multiple widgets\n- App : Should be minimal authorization UI only\n- Widget-specific logic: Should live in widget target, not shared\n\n## Success Criteria\n\n- Clear architectural boundaries\n- No dead code or unnecessary sharing\n- Foundation ready for multiple widgets\n- App is simple authorization-only interface\n\n---\nRelated: HT-1\nTracked in beads: ht-w93","status":"closed","priority":2,"issue_type":"task","assignee":"NickChristensen","created_at":"2025-12-01T17:52:37Z","updated_at":"2025-12-15T13:19:56.31601-06:00","closed_at":"2025-12-13T15:41:13Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/20","labels":["refactor"]}
{"id":"HT-18","title":"Implement weekday-specific average data caching","description":"## Problem\n\nAfter implementing weekday-based average calculations in HT-9 (commit 3ee7c0d), we're now calculating averages based on the last ~10 occurrences of the current weekday (e.g., last 10 Saturdays) instead of a rolling 30-day window. This accounts for weekday variability in activity patterns and schedules.\n\nHowever, our **average data caching strategy hasn't been updated** to match this weekday-based approach. Currently:\n\n- We have a single  that stores the most recently calculated average pattern\n- When the day changes (e.g., Saturday → Sunday at midnight), the cache still contains Saturday's average pattern\n- The widget falls back to this stale Saturday cache when trying to render Sunday's average line\n- This creates a mismatch: showing Saturday's activity pattern on a Sunday\n\n## Current Caching Implementation\n\n**Location:** \n\nThe cache structure:\n\nWelcome to Swift!\n\nSubcommands:\n\n  swift build      Build Swift packages\n  swift package    Create and work on packages\n  swift run        Run a program from a package\n  swift test       Run package tests\n  swift repl       Experiment with Swift code interactively\n\n  Use `swift --version` for Swift version information.\n\n  Use `swift --help` for descriptions of available options and flags.\n\n  Use `swift help \u003csubcommand\u003e` for more information about a subcommand.\n\nThis is a single cache without weekday awareness.\n\n## Proposed Solution\n\nImplement **weekday-specific caching** with separate caches for each day of the week:\n\n### 1. Cache Structure Update\n\n\nWelcome to Swift!\n\nSubcommands:\n\n  swift build      Build Swift packages\n  swift package    Create and work on packages\n  swift run        Run a program from a package\n  swift test       Run package tests\n  swift repl       Experiment with Swift code interactively\n\n  Use `swift --version` for Swift version information.\n\n  Use `swift --help` for descriptions of available options and flags.\n\n  Use `swift help \u003csubcommand\u003e` for more information about a subcommand.\n\n### 2. Cache Manager Updates\n\nUpdate  to:\n- Load/save the appropriate weekday cache based on current day\n- Maintain backward compatibility with existing single cache\n- Migrate existing cache to the correct weekday slot on first load\n\n### 3. Fallback Strategy\n\nWhen fetching average data for a specific weekday:\n1. Try to fetch fresh data from HealthKit\n2. On failure, check if we have a cached average for the current weekday\n3. If weekday cache is stale (\u003e7 days old), try to use it anyway (better than wrong weekday)\n4. If no weekday cache exists, fall back to empty average data\n\n## Benefits\n\n✅ **Accurate fallback data**: When locked on Sunday, widget shows Sunday's average pattern (from last week), not Saturday's\n✅ **Better UX at midnight**: Smooth transition to correct weekday pattern instead of showing wrong day's data\n✅ **Consistent with weekday-based calculations**: Cache strategy matches computation strategy\n✅ **Longer cache validity**: Sunday cache from last week is more relevant than yesterday's Saturday cache\n\n## Implementation Tasks\n\n- [ ] Create  data structure\n- [ ] Update  to support weekday-specific caching\n- [ ] Add migration logic for existing single cache → weekday cache\n- [ ] Update widget timeline provider to use weekday-specific cache fallback\n- [ ] Add logging to track which weekday cache is being used\n- [ ] Test midnight transitions (verify correct weekday cache is loaded)\n- [ ] Test cache migration (existing users don't lose cached data)\n\n## Related Issues\n\n- Introduced in: HT-9 \"Change average calculation to use the current weekday to account for weekday variability\"\n- Implemented in: commit \n- Related to: Current work on cache-based authorization strategy\n\n## Acceptance Criteria\n\n- [ ] Widget on Sunday uses Sunday average cache (from last week), not Saturday cache\n- [ ] Cache manager correctly loads/saves to weekday-specific slots\n- [ ] Existing cache data is migrated without data loss\n- [ ] Logs clearly show which weekday cache is being used\n- [ ] All 7 weekday caches can be populated and retrieved independently\n\n---\n\n**Note:** This is a follow-up improvement discovered while implementing cache-based authorization. The current implementation works but could be more accurate with weekday-aware caching.","status":"closed","priority":2,"issue_type":"task","assignee":"NickChristensen","created_at":"2025-12-06T02:46:04Z","updated_at":"2025-12-15T13:19:56.252933-06:00","closed_at":"2025-12-06T22:59:36Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/22"}
{"id":"HT-19","title":"Use cache timestamp as 'now' when displaying cached data","description":"## Problem\n\nAfter implementing cache-based fallback (commit ceacd76), we can now show cached data when HealthKit queries fail (e.g., device locked). However, the chart's \"now\" indicator is misleading in these scenarios.\n\n### Current Behavior (Incorrect)\n\n**Scenario:** It's 2:15 PM, but HealthKit returns no data. Widget falls back to cache from 11:30 AM.\n\nThe chart currently shows:\n- ❌ Vertical \"NOW\" marker at 2:15 PM\n- ❌ Average line interpolated to 2:15 PM\n- ❌ Today line ending at cached data from 11:30 AM (correct)\n- ❌ PointMarks positioned at 2:15 PM on Y-axis\n\n**Visual problem:** The chart shows \"now\" at 2:15 PM, but the today line only goes to 11:30 AM, creating a confusing 3-hour gap.\n\n### Expected Behavior (Correct)\n\nWhen using cached data from 11:30 AM, \"now\" should be 11:30 AM:\n- ✅ Vertical \"NOW\" marker at 11:30 AM\n- ✅ Average line interpolated to 11:30 AM\n- ✅ Today line ending at 11:30 AM\n- ✅ PointMarks positioned at 11:30 AM\n\nThe chart should accurately represent that we're showing a \"snapshot\" from 11:30 AM, not current live data.\n\n## Root Cause\n\n**Location:** , cache fallback logic (lines 268-300)\n\nWhen creating entries with cached data:\n\nWelcome to Swift!\n\nSubcommands:\n\n  swift build      Build Swift packages\n  swift package    Create and work on packages\n  swift run        Run a program from a package\n  swift test       Run package tests\n  swift repl       Experiment with Swift code interactively\n\n  Use `swift --version` for Swift version information.\n\n  Use `swift --help` for descriptions of available options and flags.\n\n  Use `swift help \u003csubcommand\u003e` for more information about a subcommand.\n\nThe Mon Dec 15 13:16:08 CST 2025 field is set to the current time (passed in as parameter), but it should be set to  when using cached data.\n\n## Solution\n\nUpdate cache fallback paths to use  as the entry date:\n\n### Change 1: Today's Cache (lines 268-280)\n\nWelcome to Swift!\n\nSubcommands:\n\n  swift build      Build Swift packages\n  swift package    Create and work on packages\n  swift run        Run a program from a package\n  swift test       Run package tests\n  swift repl       Experiment with Swift code interactively\n\n  Use `swift --version` for Swift version information.\n\n  Use `swift --help` for descriptions of available options and flags.\n\n  Use `swift help \u003csubcommand\u003e` for more information about a subcommand.\n\n### Change 2: Yesterday's Cache (lines 288-300)\n\nWelcome to Swift!\n\nSubcommands:\n\n  swift build      Build Swift packages\n  swift package    Create and work on packages\n  swift run        Run a program from a package\n  swift test       Run package tests\n  swift repl       Experiment with Swift code interactively\n\n  Use `swift --version` for Swift version information.\n\n  Use `swift --help` for descriptions of available options and flags.\n\n  Use `swift help \u003csubcommand\u003e` for more information about a subcommand.\n\n**Note:** For yesterday's cache, we might want to use current time since there's no today data to position. Need to discuss this edge case.\n\n### Change 3: Fresh Data Path (lines 432-442)\nConsider whether to use current time or last data point timestamp:\n\nWelcome to Swift!\n\nSubcommands:\n\n  swift build      Build Swift packages\n  swift package    Create and work on packages\n  swift run        Run a program from a package\n  swift test       Run package tests\n  swift repl       Experiment with Swift code interactively\n\n  Use `swift --version` for Swift version information.\n\n  Use `swift --help` for descriptions of available options and flags.\n\n  Use `swift help \u003csubcommand\u003e` for more information about a subcommand.\n\n## Implementation Details\n\n### Chart Elements Affected\n\nAll chart elements use  to determine \"now\":\n\n**Location:** \n\n1. **Vertical NOW marker** (line ~150):\n   \nWelcome to Swift!\n\nSubcommands:\n\n  swift build      Build Swift packages\n  swift package    Create and work on packages\n  swift run        Run a program from a package\n  swift test       Run package tests\n  swift repl       Experiment with Swift code interactively\n\n  Use `swift --version` for Swift version information.\n\n  Use `swift --help` for descriptions of available options and flags.\n\n  Use `swift help \u003csubcommand\u003e` for more information about a subcommand.\n\n2. **Average line interpolation** (line ~100):\n   \nWelcome to Swift!\n\nSubcommands:\n\n  swift build      Build Swift packages\n  swift package    Create and work on packages\n  swift run        Run a program from a package\n  swift test       Run package tests\n  swift repl       Experiment with Swift code interactively\n\n  Use `swift --version` for Swift version information.\n\n  Use `swift --help` for descriptions of available options and flags.\n\n  Use `swift help \u003csubcommand\u003e` for more information about a subcommand.\n\n3. **PointMarks** (lines ~120-140):\n   - Today PointMark at current value\n   - Average PointMark at interpolated value\n\nAll of these automatically use the entry's Mon Dec 15 13:16:08 CST 2025 field as , so updating the entry date fixes all of them.\n\n## Testing Strategy\n\n### Test Case 1: Device Locked with Today's Cache (11:30 AM cache, viewed at 2:15 PM)\n\n**Setup:**\n1. Use app at 11:30 AM (populate cache)\n2. Lock device\n3. Force widget refresh at 2:15 PM\n\n**Expected chart:**\n- Vertical \"NOW\" marker at 11:30 AM ✅\n- Today line ends at 11:30 AM ✅\n- Average line interpolated to 11:30 AM ✅\n- PointMarks at 11:30 AM position ✅\n\n**Validation:**\n- Chart should show \"snapshot from 3 hours ago\" appearance\n- No confusing gaps between last data point and NOW marker\n\n### Test Case 2: Fresh Data (Real-time)\n\n**Setup:**\n1. Device unlocked\n2. HealthKit query succeeds\n3. Current time matches data timestamp\n\n**Expected chart:**\n- Everything at current time ✅\n- No regression from current behavior\n\n### Test Case 3: Yesterday's Cache (Edge Case)\n\n**Setup:**\n1. After midnight, cache is from yesterday\n2. Widget shows average only\n\n**Question:** Should \"now\" be yesterday's timestamp or current time?\n- **Option A:** Yesterday's timestamp (shows when average was computed)\n- **Option B:** Current time (shows we're viewing it today, but with no today data)\n\nNeed to decide which is less confusing.\n\n## Edge Cases to Consider\n\n1. **Cache age indicator:** Should we show \"Data from 3 hours ago\" when using stale cache?\n2. **Timeline refresh:** Should widget request earlier refresh when showing cached data?\n3. **Yesterday cache + current time:** Which timestamp makes sense for average-only view?\n\n## Related Issues\n\n- Introduced alongside: Cache-based authorization (commit ceacd76)\n- Related to: HT-22 (weekday-specific caching)\n\n## Acceptance Criteria\n\n- [ ] Chart \"NOW\" marker matches last data timestamp when using cached data\n- [ ] Average line interpolation uses cache timestamp, not current time\n- [ ] PointMarks positioned at cache timestamp, not current time\n- [ ] Fresh data continues to show current time (no regression)\n- [ ] Logs clearly show \"Using cached data from [timestamp]\"\n- [ ] Visual appearance accurately represents data staleness\n\n---\n\n**Priority:** High - this directly impacts user trust in the widget. Showing \"now\" at 2:15 PM when data is from 11:30 AM is confusing and makes the chart appear broken.","status":"closed","priority":2,"issue_type":"task","assignee":"NickChristensen","created_at":"2025-12-06T02:55:05Z","updated_at":"2025-12-15T13:16:08.672914-06:00","closed_at":"2025-12-06T05:01:31Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/23"}
{"id":"HT-197","title":"Replace shake gesture \u0026 wrench button with triple-tap on Image to open DevTools","description":"## Problem\n\nCurrent DevTools triggering mechanisms:\n1. Shake gesture - can trigger accidentally, requires ShakeGesture utility\n2. Wrench icon button - takes up screen space, visible UI clutter\n\nBoth should be replaced with a more subtle gesture.\n\n## Requested Change\n\n**Remove:**\n- Shake gesture listener\n- Wrench icon button in the UI\n- `ShakeGesture.swift` utility file (if no longer needed)\n\n**Add:**\n- Triple-tap gesture recognizer on the Image in ContentView\n- Opens Development Tools sheet on triple tap\n\n## Why This Matters\n\n- Cleaner UI (no wrench button)\n- Less accidental triggering (triple-tap more deliberate than shake)\n- Simpler codebase (remove ShakeGesture utility)\n- More discoverable (tap on the actual content, not hidden shake)\n\n## Expected Outcome\n\nUser can triple-tap the Image in ContentView to open Development Tools. No wrench button visible, no shake gesture.\n\n## Files Likely Involved\n\n- `HealthTrends/Views/App/ContentView.swift` - Add triple-tap gesture, remove wrench button\n- `HealthTrends/Utilities/ShakeGesture.swift` - Delete file (if no other uses)\n- Any view using `.onShake()` modifier - Remove shake listener","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-17T23:46:29.903852-06:00","updated_at":"2025-12-19T16:06:54.691849-06:00","closed_at":"2025-12-19T16:06:54.691849-06:00","close_reason":"Completed"}
{"id":"HT-2","title":"Fix widget refresh timer - widgets don't auto-refresh","description":"The app and widget refresh pipeline needs to be rethought. Currently:\n\n## App Issues\n- App has a 1-minute timer that maybe pulls health data, but the chart never redraws\n- Chart doesn't update when app is activated/foregrounded\n- Visual data appears stale even if underlying data is fresh\n\n## Widget Issues\n- Widget doesn't seem to refresh at all\n- Not clear when/how widget updates should happen\n\n## Questions to investigate\n- When is it possible to refresh widgets? (app activation, backgrounding, time-based?)\n- What are the best practices for widget refresh timing?\n- Are there iOS limitations on refresh frequency?\n\n## Desired behavior\n- **App should:** Refresh health data AND redraw chart when activated/foregrounded\n- **App should:** Refresh health data AND redraw chart every minute (timer already exists?)\n- **Widget should:** Refresh when ??? (need to determine what's possible and recommended)\n- **Widget should:** Write updated data to shared container so widget can read it\n\n## Data flow audit needed\n1. HealthKitManager pulls data → writes to shared container\n2. App reads from HealthKitManager → updates UI\n3. Widget reads from shared container → displays in timeline\n4. When does each step happen?\n\n---\n_Migrated from beads issue ht-fdq_","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-16T17:47:17Z","updated_at":"2025-11-16T22:39:15Z","closed_at":"2025-11-16T22:39:15Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/2"}
{"id":"HT-20","title":"Adjust iPad wide layout in ContentView","description":"Adjust the iPad wide layout in ContentView to better use space. Keep this issue brief; details to be refined during implementation.","status":"closed","priority":2,"issue_type":"task","assignee":"NickChristensen","created_at":"2025-12-06T05:18:40Z","updated_at":"2025-12-06T06:02:39Z","closed_at":"2025-12-06T06:02:39Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/24"}
{"id":"HT-21","title":"Goal metric showing incorrect value on Saturdays","description":"## Description\nThe goal metric is displaying an inaccurate value on Saturdays.\n\n## Expected Behavior\nShould display 750 (Saturday goal)\n\n## Actual Behavior\nDisplays 1000 (Sunday-Friday goal)\n\n## Possible Causes\n- Data may be cached\n- Goal value may not be refreshing properly\n\n## Additional Context\niOS supports setting different active energy goals per weekday. The app appears to not be querying the goal, or using a stale cached version.","status":"closed","priority":2,"issue_type":"bug","assignee":"NickChristensen","created_at":"2025-12-06T19:35:43Z","updated_at":"2025-12-06T20:42:42Z","closed_at":"2025-12-06T20:42:42Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/25"}
{"id":"HT-22","title":"Improve authorization verification to prevent stuck permission button","description":"## Problem\n\nAfter granting HealthKit permissions, the 'Grant Health Access' button sometimes remains visible instead of disappearing.\n\n## Current Implementation\n\n**Location:** `HealthKitManager.swift:67-87`\n\n```swift\nprivate func verifyReadAuthorization() async -\u003e Bool {\n    do {\n        // Try to read SharedEnergyData cache\n        let _ = try SharedEnergyDataManager.shared.readEnergyData()\n        // Cache exists - permission granted\n        return true\n    } catch SharedDataError.fileNotFound {\n        // No cache - permission never granted OR first run\n        return false\n    }\n}\n```\n\n**Problem:** Only checks if `SharedEnergyData` cache exists. On first run after granting permission, cache doesn't exist yet until first data fetch completes.\n\n## Cache Context\n\nWe have two separate caches:\n\n1. **SharedEnergyData** (`energy-data.json`)\n   - Contains: today data + average data + move goal\n   - Updated: Every app refresh (~15 min)\n   - Currently used for: Authorization verification\n\n2. **AverageDataCache** (`average-data-cache.json`)\n   - Contains: average data only\n   - Updated: Once daily (6-9 AM)\n   - Currently used for: Widget primary data source\n\n## Proposed Fix\n\n```swift\nauthorizationGranted = averageCacheIsNotEmpty \n                    || todayCacheIsNotEmpty \n                    || simpleFallbackQueryToRequestOneSample()\n```\n\n**Rationale:**\n1. Average cache exists → user definitely authorized (cache refreshed daily)\n2. Today cache exists → user definitely authorized (refreshed every 15 min)\n3. No cache → perform minimal HealthKit query (1 sample) to verify permission\n\n## UI Requirements\n\n- Show button with spinner/loading state while verification checks run\n- Only show 'Grant Access' when verification definitively returns false\n- Don't flash button states during async verification\n\n## Files to Modify\n\n- `HealthTrends/Managers/HealthKitManager.swift` (verifyReadAuthorization)\n- `HealthTrends/Views/App/ContentView.swift` (add loading state to button)","status":"closed","priority":2,"issue_type":"bug","assignee":"NickChristensen","created_at":"2025-12-06T20:00:54Z","updated_at":"2025-12-06T21:45:58Z","closed_at":"2025-12-06T21:45:58Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/26"}
{"id":"HT-23","title":"Use latest HealthKit sample timestamp for chart “Now” marker","description":"Follow-up to HT-19. Currently the chart’s “Now” marker is set to the cache write time (i.e., the time we last successfully wrote HealthKit results to the cache). This can be misleading when HealthKit data is delayed (e.g., iPad waiting on iPhone sync or iPhone waiting on Apple Watch). We should investigate and switch the “Now” marker to use the timestamp of the most recent HealthKit sample in the dataset instead of the cache write time, so the chart reflects the actual freshness of the underlying data.\n\nScenarios to consider:\n- iPad shows stale data because iPhone hasn’t synced yet—“Now” should reflect the last HK sample time, not the time we wrote the stale cache.\n- iPhone/Watch gap where no new samples have arrived—marker should stay at last sample time to avoid implying fresh data.\n- Ensure widget/app both use the same logic (shared package) and that fallbacks are sane when no samples are present.\n\nAcceptance:\n- “Now” marker uses the timestamp of the most recent HealthKit sample used to build the chart, not the cache write time.\n- Behavior is consistent across app and widget; shared logic is updated in the shared package if applicable.\n- Covers delayed-sync scenarios (iPad, Watch→iPhone gaps) without implying fresher data than exists.\n- Graceful handling when no samples are available (e.g., no marker or clear fallback).","status":"closed","priority":2,"issue_type":"task","assignee":"NickChristensen","created_at":"2025-12-06T23:11:43Z","updated_at":"2025-12-15T13:19:56.188438-06:00","closed_at":"2025-12-07T21:22:18Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/27"}
{"id":"HT-24","title":"Refactor: Prevent stale sample timestamp in widget cache fallback","description":"**From PR review #28**\n\nWhen the widget falls back to cached data after a HealthKit query failure, it uses `todayCache.latestSampleTimestamp` which could be from yesterday if the cache is stale. This creates timeline discontinuity where fallback entries show different NOW markers than fresh queries.\n\n**Location:** `DailyActiveEnergyWidget.swift:277-322`\n\n**Priority:** Medium (code quality improvement)\n\n**Proposed Fix:**\n```swift\n// Priority: if cache is from today use latest sample, otherwise use cache write time\nlet effectiveDate: Date\nif calendar.isDate(todayCache.lastUpdated, inSameDayAs: date) {\n    effectiveDate = todayCache.latestSampleTimestamp ?? todayCache.lastUpdated\n} else {\n    effectiveDate = todayCache.lastUpdated  // Don't use stale sample timestamp\n}\n```\n\n**Related:** PR #28","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-07T21:08:45Z","updated_at":"2025-12-08T02:01:47Z","closed_at":"2025-12-08T02:01:47Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/29"}
{"id":"HT-25","title":"Refactor: Simplify hour boundary logic in HealthKitManager","description":"**From PR review #28**\n\nThe logic for calculating `hourEnd` and prorating calories in `generateSampleData()` has duplicated `isCurrentHour \u0026\u0026 currentMinute \u003e 0` checks.\n\n**Location:** `HealthKitManager.swift:192-214`\n\n**Priority:** Low (code quality)\n\n**Proposed Refactoring:**\n```swift\nlet isCurrentHour = dayOffset == 0 \u0026\u0026 hour == currentHour\nlet isPartialHour = isCurrentHour \u0026\u0026 currentMinute \u003e 0\n\nlet hourEnd = isPartialHour ? effectiveNow : calendar.date(byAdding: .hour, value: 1, to: hourStart)!\nlet randomVariance = Double.random(in: -10...10)\nlet adjustedCalories = baseCalories + randomVariance\nlet calories = isPartialHour ? (adjustedCalories * Double(currentMinute) / 60.0) : adjustedCalories\n```\n\n**Impact:** Reduce 10 lines to 6, clearer control flow\n\n**Related:** PR #28","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-07T21:08:46Z","updated_at":"2025-12-13T15:44:48Z","closed_at":"2025-12-13T15:44:48Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/30"}
{"id":"HT-26","title":"Refactor: Simplify latest sample timestamp tracking","description":"**From PR review #28**\n\nThe optional max logic for tracking latest sample timestamp can be simplified using more idiomatic Swift.\n\n**Location:** `HealthKitQueryService.swift:281-285`\n\n**Current (5 lines):**\n```swift\nif let currentLatest = latestSampleTimestamp {\n    latestSampleTimestamp = max(currentLatest, sample.endDate)\n} else {\n    latestSampleTimestamp = sample.endDate\n}\n```\n\n**Refactored (1 line):**\n```swift\nlatestSampleTimestamp = latestSampleTimestamp.map { max($0, sample.endDate) } ?? sample.endDate\n```\n\n**Priority:** Low (code quality)\n\n**Related:** PR #28","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-07T21:08:47Z","updated_at":"2025-12-13T15:44:48Z","closed_at":"2025-12-13T15:44:48Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/31"}
{"id":"HT-27","title":"Refactor: Extract repetitive cache logging in widget","description":"**From PR review #28**\n\nThe same logging pattern is duplicated in two branches (today's cache vs yesterday's cache) in the widget timeline provider.\n\n**Location:** `DailyActiveEnergyWidget.swift:280-290, 312-322`\n\n**Priority:** Low (code quality)\n\n**Proposed Fix:** Extract to helper function:\n```swift\nprivate func logCacheUsage(\n    cacheWriteTime: Date,\n    latestSampleTime: Date?,\n    effectiveDate: Date,\n    isTodayCache: Bool\n) {\n    let cacheType = isTodayCache ? \"today's\" : \"yesterday's\"\n    Self.logger.info(isTodayCache ? \"✅ Using \\(cacheType) cached data + average cache\" : \"⚠️ Using \\(cacheType) cache - showing average only\")\n    Self.logger.info(\"   Cache write time: \\(cacheWriteTime, privacy: .public)\")\n    Self.logger.info(\"   Latest sample: \\(latestSampleTime?.description ?? \"nil\", privacy: .public)\")\n    Self.logger.info(\"   Effective NOW: \\(effectiveDate, privacy: .public)\")\n}\n```\n\n**Impact:** Eliminate duplication\n\n**Related:** PR #28","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-07T21:08:48Z","updated_at":"2025-12-13T15:44:49Z","closed_at":"2025-12-13T15:44:49Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/32"}
{"id":"HT-28","title":"Enhancement: Add SharedEnergyData constructor validation","description":"**From PR review #28**\n\nThe `SharedEnergyData` type accepts invalid data at construction time, which can lead to subtle bugs and data corruption.\n\n**Type Design Issues:**\n- **Encapsulation:** 8/10\n- **Invariant Expression:** 6/10\n- **Invariant Usefulness:** 9/10\n- **Invariant Enforcement:** 4/10\n\n**Missing Invariants:**\n- `latestSampleTimestamp ≤ lastUpdated` (temporal consistency)\n- `todayTotal == todayHourlyData.last?.calories` (data consistency)\n- `todayTotal \u003e= 0` and `moveGoal \u003e= 0` (non-negative values)\n- Hourly data is cumulative (monotonically increasing)\n\n**Proposed Fix:**\nAdd constructor validation with preconditions:\n```swift\ninit(\n    todayTotal: Double,\n    moveGoal: Double,\n    todayHourlyData: [SerializableHourlyEnergyData],\n    lastUpdated: Date,\n    latestSampleTimestamp: Date? = nil\n) {\n    precondition(todayTotal \u003e= 0, \"todayTotal must be non-negative\")\n    precondition(moveGoal \u003e= 0, \"moveGoal must be non-negative\")\n    \n    if let sampleTimestamp = latestSampleTimestamp {\n        precondition(\n            sampleTimestamp \u003c= lastUpdated,\n            \"latestSampleTimestamp cannot be after lastUpdated\"\n        )\n    }\n    \n    if let lastHourCalories = todayHourlyData.last?.calories {\n        precondition(\n            abs(lastHourCalories - todayTotal) \u003c 0.01,\n            \"todayTotal must match last hourly value\"\n        )\n    } else {\n        precondition(todayTotal == 0, \"todayTotal must be 0 when hourly data is empty\")\n    }\n    \n    self.todayTotal = todayTotal\n    self.moveGoal = moveGoal\n    self.todayHourlyData = todayHourlyData\n    self.lastUpdated = lastUpdated\n    self.latestSampleTimestamp = latestSampleTimestamp\n}\n```\n\n**Priority:** Medium (defensive programming)\n\n**Related:** PR #28","status":"closed","priority":2,"issue_type":"task","assignee":"NickChristensen","created_at":"2025-12-07T21:09:12Z","updated_at":"2025-12-12T18:53:41Z","closed_at":"2025-12-12T18:53:41Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/33"}
{"id":"HT-29","title":"Enhancement: Add SharedEnergyData domain methods","description":"**From PR review #28**\n\nThe pattern `latestSampleTimestamp ?? lastUpdated` is duplicated in multiple locations. This should be encapsulated in a domain method.\n\n**Location:** Currently duplicated in widget (lines 281, 313)\n\n**Proposed Enhancement:**\n```swift\nextension SharedEnergyData {\n    /// The effective timestamp for determining data freshness\n    /// Uses latestSampleTimestamp if available, otherwise falls back to lastUpdated\n    var effectiveTimestamp: Date {\n        latestSampleTimestamp ?? lastUpdated\n    }\n    \n    /// Returns true if data is stale relative to the given threshold\n    func isStale(threshold: TimeInterval, relativeTo date: Date = Date()) -\u003e Bool {\n        date.timeIntervalSince(effectiveTimestamp) \u003e threshold\n    }\n}\n```\n\n**Benefits:**\n- Eliminates duplication\n- Self-documenting intent\n- Consistent behavior across app and widget\n\n**Priority:** Low (code quality)\n\n**Related:** PR #28","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-07T21:09:13Z","updated_at":"2025-12-13T15:44:49Z","closed_at":"2025-12-13T15:44:49Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/34"}
{"id":"HT-3","title":"Tweak dark mode colors for better contrast and readability","description":"Dark mode colors need adjustment for better visibility and contrast.\n\n## App Issues\n- Overall app is too dark in dark mode\n- Need to brighten UI elements for better readability\n\n## Widget Issues\n- Color contrast problems in dark mode - two possible solutions:\n  1. Widget background is too light (darken it), OR\n  2. Average line/statistics colors (gray) are too dark (lighten them)\n- Need to determine which approach gives better visual hierarchy\n- Current gray colors: systemGray, systemGray2, systemGray4, systemGray6\n\n## Affected components\n- Widget background color (currently .systemBackground)\n- Average line color (systemGray4 before now, systemGray6 after)\n- Average statistic color (systemGray)\n- Total statistic circle color (systemGray4)\n- App ContentView background/elements\n\n## Goal\nEnsure all text, charts, and UI elements are easily readable in dark mode while maintaining visual hierarchy (Today \u003e Average \u003e Total in importance)\n\n---\n_Migrated from beads issue ht-4fk_","status":"closed","priority":2,"issue_type":"bug","assignee":"NickChristensen","created_at":"2025-11-16T17:47:49Z","updated_at":"2025-11-29T16:58:25Z","closed_at":"2025-11-29T16:58:25Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/3"}
{"id":"HT-30","title":"Documentation: Add SharedEnergyData invariant documentation","description":"**From PR review #28**\n\nThe `SharedEnergyData` type has important invariants that are not documented in code.\n\n**Missing Documentation:**\n\n```swift\n/// Shared data structure for communicating energy data between app and widget\n///\n/// Invariants:\n/// - `todayTotal` equals `todayHourlyData.last?.calories` (or 0 if empty)\n/// - `latestSampleTimestamp` ≤ `lastUpdated` (sample timestamp cannot be in the future relative to cache write)\n/// - `latestSampleTimestamp` represents when HealthKit last received data; `lastUpdated` represents when this cache was written\n/// - Hourly data represents cumulative calories (monotonically increasing)\nstruct SharedEnergyData: Codable {\n    // ...\n}\n```\n\n**Priority:** Low (documentation)\n\n**Related:** PR #28, see also HT-28 for enforcement","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-07T21:09:14Z","updated_at":"2025-12-15T13:19:56.116403-06:00","closed_at":"2025-12-13T15:44:49Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/35"}
{"id":"HT-31","title":"Add cache debug info to development tools sheet","description":"Added cache debugging information to the Development Tools sheet to help diagnose caching issues:\n\n**Today Data Cache:**\n- Last cache update time\n- Last HealthKit sample timestamp\n\n**Average Data Cache:**\n- Cache status for all 7 weekdays\n- Last update time per weekday\n- Projected total per weekday\n\n**New buttons:**\n- Fetch health data (runs widget query)\n- Rebuild average data cache (repopulates all weekday caches)\n\nTimestamps show relative time by default ('5 min ago') and toggle to absolute time on tap.","status":"closed","priority":2,"issue_type":"task","assignee":"NickChristensen","created_at":"2025-12-09T20:35:05Z","updated_at":"2025-12-09T20:44:50Z","closed_at":"2025-12-09T20:44:50Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/37"}
{"id":"HT-32","title":"Create type-safe font system to replace hardcoded font sizes","description":"## Problem\nCurrently, font sizes are hardcoded throughout the codebase using literals like `.caption`, `.caption2`, etc. This approach:\n- Lacks semantic meaning (what is \"caption\" used for?)\n- Makes it hard to maintain consistent typography\n- Difficult to adapt fonts for different contexts (widget sizes, accessibility)\n- No centralized control over type scale\n\n## Proposed Solution\nCreate a type-safe font system that provides semantic, context-aware font sizes similar to the asset catalog color approach.\n\n### Example Usage (Desired)\n```swift\n// Current (hardcoded, context-unaware)\n.font(.caption)\n.font(.caption2)\n\n// Proposed (semantic, context-aware)\n.font(.chartLabel)          // Automatically adjusts for widget size\n.font(.statistic)\n.font(.statisticLabel)\n```\n\n### Implementation Approach\n1. Create a font extension or custom type that provides semantic font names\n2. Support context-based sizing (e.g., different sizes for medium vs large widgets)\n3. Integrate with Dynamic Type for accessibility\n4. Centralize font definitions for easy updates\n\n### Benefits\n- Semantic naming (`.chartLabel` vs `.caption2`)\n- Context-aware sizing (automatically adapts to widget family)\n- Centralized typography system\n- Better accessibility support\n- Easier to maintain consistency across app and widgets\n\n### Current Font Usage Patterns\nFrom the codebase:\n- Chart labels: `.caption` / `.caption2` (varies by widget size)\n- Goal label: `.caption` / `.caption2` with `.bold()`\n- Statistics: Various sizes in `HeaderStatistic`\n- Context switching based on `widgetFamily`\n\n### Related Code\n- `EnergyChartView.swift`: `labelFont` computed property that switches based on widget size\n- `ChartXAxisLabels.swift`: Similar font switching logic\n\n### References\n- SwiftUI custom font approaches\n- Dynamic Type best practices\n- Typography systems in design systems","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-10T03:32:03Z","updated_at":"2025-12-10T03:35:07Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/40"}
{"id":"HT-33","title":"Remove lastUpdated field from SharedEnergyData in favor of latestSampleTimestamp","description":"## Problem\n\n`SharedEnergyData` currently has two timestamp fields:\n- `lastUpdated`: When the cache was written\n- `latestSampleTimestamp`: When the most recent HealthKit sample was recorded\n\nThe `lastUpdated` field is redundant and less useful than `latestSampleTimestamp` for all current use cases.\n\n## Current Usage of `lastUpdated`\n\n1. **Staleness check** (DailyActiveEnergyWidget.swift:297):\n   ```swift\n   let isCacheFromToday = calendar.isDate(todayCache.lastUpdated, inSameDayAs: date)\n   ```\n   Determines if cache is from today or yesterday to decide whether to show today's data or average-only view.\n\n2. **Average interpolation** (lines 284, 564):\n   ```swift\n   let averageAtCurrentHour = averageHourlyData.interpolatedValue(at: todayCache.lastUpdated) ?? 0\n   ```\n   Interpolates average value at cache write time.\n\n3. **Widget gallery entry date** (line 567):\n   ```swift\n   return EnergyWidgetEntry(date: todayCache.lastUpdated, ...)\n   ```\n\n4. **Logging/debug UI** (CacheDebugView.swift)\n\n## Why `latestSampleTimestamp` is Better\n\n**For staleness check (HT-1):** We should check if the *actual data* is from today, not when we wrote the cache. Example:\n- iPad queries HealthKit at 11:59 PM but iPhone hasn't synced since 8 AM\n- `lastUpdated` = 11:59 PM (today) ✅ passes staleness check\n- `latestSampleTimestamp` = 8 AM (today) ❌ correctly identifies stale data\n- Using `latestSampleTimestamp` prevents showing 15-hour-old data as \"fresh\"\n\n**For interpolation (HT-2):** Should interpolate at sample time, not cache write time, for same reason.\n\n**For entry date (HT-3):** Entry date should reflect actual data freshness, not cache write time.\n\n## Proposed Solution\n\n1. Remove `lastUpdated` field from `SharedEnergyData`\n2. Update all usages to use `latestSampleTimestamp` instead\n3. Handle `nil` case appropriately (when no samples exist):\n   - Staleness check: Treat as stale (fail-safe)\n   - Interpolation: Use current time or skip\n   - Entry date: Use current time as fallback\n\n## Impact\n\n**Files to update:**\n- `HealthTrends/Models/SharedEnergyData.swift` - Remove field from struct\n- `DailyActiveEnergyWidget/DailyActiveEnergyWidget.swift` - Update staleness check, interpolation, entry date\n- `HealthTrends/Views/App/CacheDebugView.swift` - Update debug UI\n- `documentation/caching-strategy.md` - Update documentation\n\n**Breaking change:** Yes, this changes the cache schema. Old caches will fail to decode.\n- **Migration strategy:** Just let it fail - app will regenerate cache on next refresh\n- Alternative: Add default value to maintain backward compatibility temporarily\n\n## Acceptance Criteria\n\n- [ ] `lastUpdated` field removed from `SharedEnergyData`\n- [ ] Staleness check uses `latestSampleTimestamp` with appropriate nil handling\n- [ ] Average interpolation uses `latestSampleTimestamp`\n- [ ] Widget entry date uses `latestSampleTimestamp`\n- [ ] Debug UI updated to show only `latestSampleTimestamp`\n- [ ] Documentation updated\n- [ ] All code compiles and runs\n- [ ] Widget correctly handles nil `latestSampleTimestamp` case\n- [ ] Tested with fresh data and stale/delayed-sync scenarios","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T02:02:59Z","updated_at":"2025-12-15T13:19:56.04681-06:00","closed_at":"2025-12-11T03:04:58Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/42"}
{"id":"HT-34","title":"Update codebase terminology to align with PRD","description":"## Overview\nAlign code terminology with Product Requirements Document (PRD) for consistency and clarity.\n\n## Changes Needed\n\n### 1. Rename \"NOW\" to \"Data Time\"\n- [ ] Update variable names: `now` → `dataTime` or `effectiveDataTime`\n- [ ] Update comments referencing \"NOW\"\n- [ ] Update parameter names in functions\n- [ ] Update documentation strings\n\n**Context:** \"Data Time\" represents the timestamp of the most recent HealthKit data sample, which typically matches current time but may lag during sync delays. This is more accurate than \"NOW\" which implies always-current time.\n\n**Files likely affected:**\n- `EnergyChartView.swift`\n- `DailyActiveEnergyWidget.swift`\n- `HealthKitQueryService.swift`\n\n### 2. Remove incorrect color references in comments/docs\n- [ ] Check for \"green\" references to move goal line (actually gray/systemGrayColor)\n- [ ] Check for \"blue\" references to today line (actually orange AccentColor)\n- [ ] Update any color descriptions to be accurate or remove color specifics\n\n**Context:** During PRD review, discovered documentation incorrectly described chart colors. Move goal line uses `systemGrayColor`, today line uses `AccentColor` (orange: RGB 1.0, 0.286, 0.0). Check for similar inaccuracies in code comments.\n\n**Files likely affected:**\n- Any files with chart-related comments\n- `EnergyChartView.swift`\n\n## Additional Changes\n_(Will be added as we identify more terminology mismatches)_\n\n---\n\n**Reference:** See `documentation/PRD.md` for authoritative terminology","status":"closed","priority":2,"issue_type":"task","assignee":"NickChristensen","created_at":"2025-12-11T21:09:35Z","updated_at":"2025-12-12T02:05:03Z","closed_at":"2025-12-12T02:05:03Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/45"}
{"id":"HT-35","title":"Investigate: Does widget write to shared cache or only read?","description":"## Question\n\nDoes the widget extension write to the shared container cache ( and ), or does it only read from it?\n\n## Current Understanding (from PRD/docs)\n\n**Cache Strategy (F4):**\n- App writes to shared container after HealthKit queries\n- Widget reads from shared container as fallback when queries fail\n\nThis suggests widget is **read-only**, but need to verify.\n\n## Why This Matters\n\nIf widget only reads and never writes:\n- Widget's successful HealthKit queries don't update the cache\n- Cache only updates when app runs\n- Could explain data staleness when user rarely opens app but frequently views widget\n\n## Investigation Steps\n\n- [ ] Check  - does  write to cache after successful queries?\n- [ ] Check  - does app write after queries?\n- [ ] Verify: When widget successfully queries HealthKit, does it update ?\n- [ ] Verify: When widget successfully queries HealthKit, does it update ?\n\n## Potential Issues\n\nIf widget doesn't write to cache:\n- User who rarely opens app but checks widget frequently = stale cache\n- Cache freshness depends on app usage, not widget usage\n- Widget could successfully query HealthKit but not persist for next widget refresh\n\n## Expected Outcome\n\nDocument actual behavior and update PRD/caching-strategy.md to reflect reality.\n\nIf widget should write but doesn't: consider implementing widget cache writes for better freshness.\n\n---\n\n**Related:** HT-34 (PRD terminology alignment)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T21:26:10Z","updated_at":"2025-12-16T13:12:10.28598-06:00","closed_at":"2025-12-16T13:12:10.28598-06:00","close_reason":"Fixed: Widget now writes to TodayEnergyCache after successful queries","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/46","dependencies":[{"issue_id":"HT-35","depends_on_id":"HT-34","type":"blocks","created_at":"2025-12-15T13:34:59.071541-06:00","created_by":"daemon","metadata":"{}"}]}
{"id":"HT-36","title":"Update deprecated cornerRadius() to clipShape(.rect(cornerRadius:))","description":"## Description\n\nAccording to CLAUDE.md Modern API Usage guidelines (line 124), we should replace deprecated  with  for iOS 17+ apps.\n\n## Current Usage\n\n**Location:** \n\n\nWelcome to Swift!\n\nSubcommands:\n\n  swift build      Build Swift packages\n  swift package    Create and work on packages\n  swift run        Run a program from a package\n  swift test       Run package tests\n  swift repl       Experiment with Swift code interactively\n\n  Use `swift --version` for Swift version information.\n\n  Use `swift --help` for descriptions of available options and flags.\n\n  Use `swift help \u003csubcommand\u003e` for more information about a subcommand.\n\n## Recommended Change\n\n\nWelcome to Swift!\n\nSubcommands:\n\n  swift build      Build Swift packages\n  swift package    Create and work on packages\n  swift run        Run a program from a package\n  swift test       Run package tests\n  swift repl       Experiment with Swift code interactively\n\n  Use `swift --version` for Swift version information.\n\n  Use `swift --help` for descriptions of available options and flags.\n\n  Use `swift help \u003csubcommand\u003e` for more information about a subcommand.\n\n## Why\n\n-  is deprecated in iOS 17+\n-  provides access to advanced features and is the modern API\n- Follows project coding standards defined in CLAUDE.md\n\n## Context\n\nThis issue was identified during code review of PR #47. While not blocking that PR (which focuses on terminology updates), this is technical debt worth addressing separately.\n\n## References\n\n- CLAUDE.md line 124: Modern API Usage guidelines\n- PR HT-47: https://github.com/NickChristensen/HealthTrends/pull/47","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-12T02:10:38Z","updated_at":"2025-12-19T16:47:27.86993-06:00","closed_at":"2025-12-19T16:47:27.871203-06:00","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/48"}
{"id":"HT-4","title":"Rework medium widget layout to give more room for graph","description":"The medium widget layout feels cramped - the chart doesn't have enough vertical space to be easily readable at a glance.\n\n## Current layout issues\n- Header statistics take up too much vertical space\n- Chart is compressed, making it harder to read trends\n- Could optimize spacing between elements\n\n## Potential improvements\n- Reduce header statistics font size or spacing\n- Make the chart taller (more vertical space)\n- Consider alternative layouts (stack statistics differently?)\n- Ensure all data remains readable while maximizing chart space\n\n---\n_Migrated from beads issue ht-cbq_","status":"closed","priority":2,"issue_type":"task","assignee":"NickChristensen","created_at":"2025-11-16T17:48:31Z","updated_at":"2025-12-09T22:36:09Z","closed_at":"2025-12-09T22:36:09Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/4","labels":["improvement"]}
{"id":"HT-4n6","title":"Bug: Multiple average data lines rendered on chart","description":"## Problem\nWidget chart is rendering multiple gray average data lines instead of a single line.\n\n**Observed:**\n- Clock time: 8:00am\n- Last sample: 7:54am\n- Multiple overlapping gray lines visible on chart\n\n## Expected Behavior\nSingle gray average data line should be rendered\n\n## Likely Causes\n- Duplicate data points in `averageHourlyData` array\n- Chart marks being drawn multiple times\n- State/view update issue causing re-rendering\n- Data filtering/processing issue before chart construction\n\n## Investigation Needed\n- Check `EnergyChartView.swift` for how average data marks are constructed\n- Verify `averageHourlyData` array doesn't contain duplicates\n- Check if chart state updates are causing multiple draws\n\n## Files Likely Involved\n- `DailyActiveEnergyWidget/EnergyChartView.swift` (chart rendering)\n- `DailyActiveEnergyWidget/EnergyTrendView.swift` (data passing to chart)","status":"open","priority":2,"issue_type":"bug","created_at":"2025-12-16T12:54:08.157223-06:00","updated_at":"2025-12-16T12:54:08.157223-06:00"}
{"id":"HT-5","title":"Create an icon","description":"Design and implement a custom app icon for HealthTrends. Currently using the default Xcode placeholder icon.\n\n## Requirements\nThe icon should:\n- Represent health/fitness/energy tracking\n- Work well at all iOS icon sizes\n- Follow iOS design guidelines\n- Be visually distinct and recognizable\n\n---\n_Migrated from beads issue ht-cme_","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-16T17:49:00Z","updated_at":"2025-11-23T17:50:39Z","closed_at":"2025-11-23T17:50:39Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/5","labels":["improvement"]}
{"id":"HT-6","title":"Average line/marker rendering broken toward end of day","description":"In-app rendering of Average line(s) and average point marker doesn't work as expected, seemingly beyond 10pm. \n- PointMarker not visible at all\n- Average line (up to current hour) stops around 10pm\n- Average line (to rest of day) not visible at all\n\nSee examples below, with timestamps:\n\nScreenshot 2025-11-15 at 11.58.40 PM\n\u003cimg width=\"603\" height=\"1311\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/16735e95-45ac-4ad4-beb5-4834335ba51b\" /\u003e\n\nScreenshot 2025-11-19 at 11.59.46 PM\n\u003cimg width=\"603\" height=\"1311\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/277ec5b9-9403-4497-aeaf-d16c66d16231\" /\u003e","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-23T18:27:25Z","updated_at":"2025-11-24T18:37:20Z","closed_at":"2025-11-24T18:37:19Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/6"}
{"id":"HT-7","title":"[widget] Inaccurate or missing `LineMark`s","description":"Often happens when the app hasn't been opened for a while. Upon opening the app, the widget re-renders correctly. This can happen to the `todayLine`, or either of the `averageLines`. I suspect this is a problem with the data fetching or computation code paths that the widget uses, not the chart itself.\n\nExamples:\n\n\u003cimg width=\"603\" height=\"565\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/2795690f-2575-43cf-974e-62f8eecbf472\" /\u003e\n\u003cimg width=\"603\" height=\"571\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/918c6052-eee2-4cc3-b74f-5a90484e1e54\" /\u003e\n\u003cimg width=\"603\" height=\"568\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/446c2d88-f45c-4df6-ae40-d6661441d090\" /\u003e","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-23T21:28:57Z","updated_at":"2025-11-23T22:39:40Z","closed_at":"2025-11-23T22:39:40Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/7"}
{"id":"HT-763","title":"Bug: Widget shows incorrect \"Today\" value (658 vs 584 in Health app)","description":"## Problem\nWidget displays Today: 658 cal, but Health app shows 584 cal (74 cal difference)\nData time: 4:32 PM, Clock time: 4:42 PM\n\n## Hypothesis\nPossibly introduced by HT-8cu normalization changes. Could be:\n1. Widget using stale cached data instead of fresh HealthKit query\n2. Date/timestamp issue in query causing wrong day's data to be fetched\n3. Cumulative calculation error in fetchTodayHourlyTotals\n\n## Investigation Needed\n- Check widget logs to see if HealthKit query succeeded or fell back to cache\n- Verify query date range matches actual \"today\"\n- Compare raw HealthKit samples vs widget display\n- Check if normalizeTimestamps is being incorrectly applied to todayHourlyData","notes":"This is a result of duplicate, overlapping workouts","status":"tombstone","priority":1,"issue_type":"bug","created_at":"2025-12-16T16:45:12.207374-06:00","updated_at":"2025-12-18T00:08:48.951016-06:00","deleted_at":"2025-12-18T00:08:48.951016-06:00","deleted_by":"git-history-backfill","delete_reason":"recovered from git history (pruned from manifest)","original_type":"bug"}
{"id":"HT-8","title":"Completely invalidate widget data to force a pre-render at midnight?","description":"See screenshot. The 685 value for \"Today\" is stale data from the last time the widget rendered, which was the previous day. Are we able to schedule a widget render at (or close to) midnight, with 0 values for \"Today\"?\n\n\u003cimg width=\"360\" height=\"360\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/e9997238-e361-4aad-96b9-9ff9423edc9b\" /\u003e","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-23T21:38:08Z","updated_at":"2025-11-26T04:07:28Z","closed_at":"2025-11-26T04:07:28Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/8"}
{"id":"HT-8cu","title":"Bug: Average line rendered off-chart (to the left)","description":"## Problem\nAverage data line is rendered entirely off the left edge of the chart, making it invisible.\n\n**Observed:**\n- Clock time: 12:03 AM - average line off-chart\n- Clock time: 7:33 AM - average line off-chart\n- Average values (838 cal, 426 cal) are displayed but line not visible on chart\n\n## Expected Behavior\nAverage line should be rendered on the chart, aligned with today's timeline\n\n## Root Cause Hypothesis\n**Reading yesterday's data** - if `averageHourlyData` contains timestamps from yesterday instead of today, all x-positions would be offset by 24 hours into negative territory (off the left edge of the chart).\n\n## Likely Causes\n1. **Date mismatch**: Average data timestamps are from wrong day (yesterday)\n2. **Stale cache**: `WeekdayAverageCache` contains old data with yesterday's dates\n3. **Date normalization bug**: Average data not being normalized to today's date range before charting\n4. **Chart domain**: X-axis domain may be correct but data timestamps are wrong\n\n## Investigation Needed\n- Check `averageHourlyData` timestamps in widget timeline entry\n- Verify `WeekdayAverageCache` is returning current-day-normalized timestamps\n- Check if average data date normalization is happening before chart rendering\n- Inspect `EnergyChartView.swift` x-axis domain vs actual data timestamps\n\n## Files Likely Involved\n- `DailyActiveEnergyWidget/EnergyChartView.swift` (chart x-axis configuration)\n- `HealthTrendsShared/Sources/HealthTrendsShared/HealthKitQueryService.swift` (average data query)\n- `HealthTrendsShared/Sources/HealthTrendsShared/AverageDataCache.swift` (cache read logic)","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-16T12:59:24.405416-06:00","updated_at":"2025-12-16T14:37:28.805744-06:00","closed_at":"2025-12-16T14:37:28.805744-06:00","close_reason":"Fixed midnight timeline to load correct weekday's average data with normalized timestamps"}
{"id":"HT-9","title":"Change average calculation to use the current weekday to account for weekday variability","description":"ie instead of last 30 days, show average of last n (10?) Saturdays\n\nThis will make averages more helpful because weekdays vary both in total active calories and also schedule","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-23T23:43:45Z","updated_at":"2025-11-30T19:46:53Z","closed_at":"2025-11-30T19:46:53Z","external_ref":"https://github.com/NickChristensen/HealthTrends/issues/9","labels":["improvement"]}
{"id":"HT-9y8","title":"Audit test coverage of all EnergyWidgetEntry creation paths","description":"Investigate which of the many `EnergyWidgetEntry` creation paths are currently exercised by our integration tests.\n\n## Context\n\n`EnergyWidgetEntry` is created in multiple places across different code paths:\n\n1. **Static placeholder** (line 29) - Widget gallery\n2. **createMidnightEntry()** (line 260) - Midnight zero-state prediction\n3. **loadFreshEntry() - Success path** (line 647) - Normal HealthKit query success\n4. **loadFreshEntry() - Cache fallbacks** when HealthKit query fails:\n   - Today's cache available (line 406)\n   - Yesterday's cache (stale) (line 430)\n   - No cache found - unauthorized (line 446)\n   - Container not found (line 461)\n   - Cache corruption/DecodingError (line 478)\n   - Other unexpected cache error (line 494)\n   - Average cache query failed, no stale cache (line 576)\n5. **loadCachedEntry() paths** (widget gallery):\n   - Cache load success (line 687)\n   - Cache load failure (line 700)\n\nAnd potentially more.\n\n## Investigation Tasks\n\n1. Map each test scenario to specific entry creation paths\n2. Identify which paths are NOT currently tested\n3. Determine if untested paths need test coverage\n4. Consider code coverage tools (Xcode coverage, swift test --enable-code-coverage)\n\n## Acceptance Criteria\n\n- Document which entry creation paths each test exercises\n- Identify gaps in test coverage\n- Recommend additional tests if needed (or document why paths don't need tests)\n- Consider: Do we need to test error paths like cache corruption, container not found, etc?","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-19T09:05:46.006794-06:00","updated_at":"2025-12-20T09:11:18.045996-06:00","closed_at":"2025-12-20T09:11:18.045996-06:00","close_reason":"Audit complete: Identified 12 entry creation paths, 1 tested (100%), 11 untested (0%). Recommended adding cache fallback tests (HIGH), error handling tests (MED), and midnight entry tests (MED). Coverage tools: xcodebuild -enableCodeCoverage + xcrun xccov. See comments for detailed analysis and recommendations.","dependencies":[{"issue_id":"HT-9y8","depends_on_id":"HT-b5y","type":"blocks","created_at":"2025-12-19T09:05:46.01157-06:00","created_by":"daemon","metadata":"{}"}],"comments":[{"id":2,"issue_id":"HT-9y8","author":"nick","text":"# Test Coverage Audit Complete\n\n**Coverage Run:** 2025-12-20_09-00-28  \n**Overall:** 24.97% (212/849 lines) of `DailyActiveEnergyWidget.swift`  \n**Key Function:** `loadFreshEntry()` at 44.62% (170/381 lines)\n\n## Summary of Entry Creation Paths\n\n### ✅ TESTED (1 path)\n\n**#3: Fresh HealthKit Query SUCCESS** (lines 655-665) - **100% covered**\n- All 4 current test scenarios exercise this path\n- Tests validate: normal operation, delayed sync, stale data, unauthorized states\n- **Finding:** Tests simulate different data conditions but always use successful HealthKit mocks\n\n### ❌ NOT TESTED (11 paths)\n\n**Critical Gaps (Should Test):**\n\n**#4: HealthKit Failed → Today's Cache** (lines 414-426) - 0%\n- Real scenario: Device locked, HealthKit temporarily unavailable\n- Widget falls back to today's cached data\n- **Impact:** High - this is a key resilience feature never tested\n\n**#5: HealthKit Failed → Yesterday's Cache (Stale)** (lines 438-448) - 0%\n- Returns average-only display (no today line)\n- Happens when cache exists but from previous day\n\n**#2: Midnight Entry Creation** (lines 249-280) - 0%\n- Creates zero-state entry at day transition\n- Loads new weekday's average projection\n\n**Error Handling Paths (0% each):**\n- #6: No cache (unauthorized) - lines 454-464\n- #7: Container not found (config error) - lines 469-479\n- #8: Cache corruption (DecodingError) - lines 486-496\n- #9: Other unexpected cache error - lines 502-512\n- #10: Average query failed, no fallback - lines 584-594\n\n**Low Priority:**\n- #1: Static placeholder (widget gallery) - lines 28-40\n- #11: loadCachedEntry() success - lines 694-706\n- #12: loadCachedEntry() failure - lines 707+\n\n## Recommendations\n\n### 1. HIGH Priority: Cache Fallback Tests\n\nCreate `Scenario5_CacheFallbackTests.swift`:\n- Test today's cache fallback when HealthKit throws error\n- Test yesterday's (stale) cache fallback\n- Test device-locked scenario (HKError.errorDatabaseInaccessible)\n\n**Implementation approach:**\n```swift\nclass MockHealthKitQueryService {\n    var shouldThrowError: Bool = false\n    var errorToThrow: Error?\n    \n    func fetchTodayHourlyTotals() async throws {\n        if shouldThrowError { throw errorToThrow! }\n        // ... normal mock behavior\n    }\n}\n```\n\n**Coverage Impact:** Would test 2 major untested paths that handle real-world failures\n\n### 2. MEDIUM Priority: Error Handling Tests\n\nCreate `Scenario6_ErrorHandlingTests.swift`:\n- Test unauthorized state (no cache)\n- Test cache corruption (DecodingError)\n- Test container misconfiguration\n\n**Coverage Impact:** Would test 4 error paths\n\n### 3. MEDIUM Priority: Midnight Timeline Test\n\nAdd test for `createMidnightEntry()`:\n- Verify zero today total at midnight\n- Verify correct weekday average loads for new day\n\n**Coverage Impact:** Would test 1 untested timeline path\n\n## Code Coverage Commands\n\n```bash\n# Run with coverage\nxcodebuild test -quiet -scheme HealthTrendsWidgetTests \\\n  -destination 'platform=iOS Simulator,name=iPhone 17 Pro' \\\n  -enableCodeCoverage YES\n\n# View report\nxcrun xccov view --report \\\n  ~/Library/Developer/Xcode/DerivedData/HealthTrends-*/Logs/Test/*.xcresult\n```\n\n## Conclusion\n\n**Current:** Tests comprehensively cover happy path (100% of PRD scenarios).  \n**Gap:** All error recovery \u0026 cache fallback paths are untested (0%).  \n**Impact:** Adding recommended tests would increase coverage from **25%** to **~60-70%**.\n\nThe untested paths aren't theoretical edge cases - they're real-world failure modes (device locked, cache stale) that the code explicitly handles but we've never verified work correctly.\n","created_at":"2025-12-20T15:11:02Z"}]}
{"id":"HT-a50","title":"Investigate best way to run tests (xcodebuild vs swift test vs IDE)","description":"Research and document the best approach for running widget integration tests:\n- xcodebuild test (command line, CI-friendly)\n- swift test (for shared package tests)\n- Xcode IDE test runner (interactive debugging)\n- Performance characteristics of each\n- Recommended workflow for development vs CI\n\nCurrent observation: xcodebuild test takes a long time to run, and agents are seemingly unable to read the test results.","notes":"## Findings\n\n**Recommended Command:**\n```bash\nxcodebuild test -quiet -scheme HealthTrendsWidgetTests -destination 'platform=iOS Simulator,name=iPhone 17 Pro'\n```\n\n**Why xcodebuild over swift test:**\n- `swift test` designed for cross-platform packages (macOS/Linux)\n- iOS-specific frameworks (HealthKit, WidgetKit) require iOS SDK\n- `xcodebuild test` is Apple's recommended approach for iOS apps/extensions\n\n**Benefits of `-quiet` flag:**\n- Suppresses verbose build output\n- Shows clean test results (pass/fail per test)\n- Fast feedback (\u003c 1 minute for full suite)\n\n**Test Results (13 tests total):**\n- ✅ 10 passed\n- ❌ 4 failed (scenarios 2-4 need fixture adjustments)\n\n**Performance:**\n- Full test suite: ~48 seconds\n- Scenario 1 (3 tests): All passing with exact assertions\n\n**Alternative for Shared Package:**\nCannot use `swift test` because package is iOS-only (requires HealthKit). Must use xcodebuild even for package tests.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T17:00:35.071411-06:00","updated_at":"2025-12-18T23:51:14.138367-06:00","closed_at":"2025-12-18T23:51:14.138367-06:00","close_reason":"Determined that xcodebuild test -quiet is the recommended approach for iOS testing. Swift test doesn't work for iOS-only packages with HealthKit dependencies.","dependencies":[{"issue_id":"HT-a50","depends_on_id":"HT-b5y","type":"blocks","created_at":"2025-12-18T17:00:35.074319-06:00","created_by":"daemon","metadata":"{}"}]}
{"id":"HT-avs","title":"Bug: Duplicate midnight point in average data causes extra line segment","description":"## Problem\nExtra line segment appears in widget showing average data going from ~1000 cal (projected total) down to current average at dataTime.\n\n## Root Cause\n`fetchCumulativeAverageHourlyPattern` creates hour-23 data point as hour+1=24 (midnight next day) with projected total. After `normalizeTimestamps()`, this becomes midnight of CURRENT day, creating duplicate midnight entries:\n1. Explicit midnight (0 cal) from line 425\n2. Normalized hour-23+1 midnight (~1000 cal) \n\nBoth pass `cleanedAverageData` filter and get rendered, creating visible line artifact.\n\n## Solution\n`normalizeTimestamps()` should exclude the next-day midnight point OR dedup midnight points after normalization.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-16T16:28:32.052932-06:00","updated_at":"2025-12-16T16:32:38.126021-06:00","closed_at":"2025-12-16T16:32:38.126021-06:00","close_reason":"Fixed by filtering out next-day midnight endpoint in normalizeTimestamps() to prevent duplicate midnight entries"}
{"id":"HT-b5y","title":"Add test framework, integration test suite for widget","description":"We need to\na) confirm that product requirements are fulfilled with current code\nb) put guardrail tests in place to aid in a potential future refactor\n\nStart with the User Scenarios outlined in documentation/PRD.md\nFor each scenario:\n- Create mock data to represent Active Energy Data in healthkit\n- Stub EnergyTrendView, and test that the arguments passed into it are correct for the given scenario\n- For now, do not write unit tests. Write integration tests that confirm that with data `x` returned from HealthKit, EnergyTrendView is called with `y` arguments.\n\nWe may add unit tests in the future, when we have more confidence in the accuracy and architecture of the current system.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T11:46:12.347487-06:00","updated_at":"2025-12-18T21:04:41.080954-06:00","closed_at":"2025-12-18T21:04:41.080954-06:00","close_reason":"Completed comprehensive test framework and integration test suite covering all 4 PRD scenarios with 100% deterministic fixtures"}
{"id":"HT-fuu","title":"Adopt casey/just as command runner for build, test, and lint tasks","description":"Adopt casey/just (https://github.com/casey/just) as the project's command runner to standardize and simplify common development tasks.\n\nCreate a justfile with commands for:\n- `just build` - Build the app for simulator\n- `just install` - Build and install to simulator (iPhone 17 Pro)\n- `just install-device` - Build (production) and install to physical device\n- `just test` - Run test suite\n- `just lint` - Run linting/code quality checks\n\nBenefits:\n- Single source of truth for development commands\n- Simpler onboarding for new developers\n- Consistent command interface across team\n- Self-documenting with `just --list`","acceptance_criteria":"- justfile created with all 5 commands working\n- Commands properly use xcodebuild with correct schemes and destinations\n- Default simulator set to iPhone 17 Pro\n- README updated with just installation and usage instructions\n- All commands tested and verified working","status":"open","priority":2,"issue_type":"chore","created_at":"2025-12-20T08:32:44.700854-06:00","updated_at":"2025-12-20T08:32:44.700854-06:00"}
{"id":"HT-h01","title":"Code review improvements to testing","description":"Code review improvements from PR #55 (comments 3675424238 and 3676404127):\n\n## From Comment 3675424238\n\n### 1. Hardcoded Simulator in README\n**File:** `HealthTrendsWidgetTests/README.md:43`\n**Issue:** Tests will fail in CI or on machines without \"iPhone 17 Pro\" simulator. Xcode 15/16 may have different default simulators.\n**Current:**\n```bash\n-destination 'platform=iOS Simulator,name=iPhone 17 Pro'\n```\n**Recommendation:** Use generic destination:\n```bash\n# Works on any machine with any iOS simulator\n-destination 'platform=iOS Simulator,name=Any iOS Simulator Device'\n\n# Or: Let xcodebuild choose\n-destination 'platform=iOS Simulator,OS=latest'\n```\n**Severity:** Medium (could break CI/CD)\n\n### 2. Partial Data Scenarios Testing\n**Context:** Integration tests cover success paths but don't test edge cases like:\n- **Partial data scenarios (e.g., only 2 historical Saturdays instead of 10)**\n- Cache file corruption (invalid JSON)\n- Container not found error\n- HealthKit query throwing errors\n\n**Specific Gap:** Widget assumes it can fetch ~10 historical occurrences of current weekday for average calculation. What happens when:\n- User just installed the app (only 1-2 weeks of data)?\n- Historical data is sparse (gaps due to device not worn)?\n- Only 2 historical Saturdays available instead of 10?\n\n**Recommendation:** Add test cases for partial historical data:\n```swift\n@Test(\"Widget handles sparse historical data (only 2 Saturdays)\")\nfunc testSparseHistoricalData() async throws {\n    // Create fixture with only 2 historical Saturday samples\n    // Verify average calculation still works\n    // Verify UI doesn't crash or show NaN\n}\n\n@Test(\"Widget handles cache corruption gracefully\")\nfunc testCacheCorruption() async throws {\n    // Write invalid JSON to cache file\n    // Verify widget returns placeholder/zero state\n}\n```\n**Severity:** Low (good for future hardening)\n\n## From Comment 3676404127\n\n### 3. CRITICAL: Making HealthKitQueryService open (Security/Architecture)\n**File:** `HealthKitQueryService.swift:8`\n**Change:** `final class` → `open class` with `open` methods\n**Problem:** Changing from `final` to `open class` weakens encapsulation and allows external subclassing/overriding of critical HealthKit logic.\n**Concerns:**\n- **Security:** HealthKit queries involve sensitive health data. Opening the class for subclassing could enable unauthorized data access patterns if app extensions or future code misuse inheritance.\n- **Architecture:** Violates principle of least privilege. Tests should not require production code to be more permissive.\n- **Maintenance:** Future developers might subclass in production code instead of using composition/protocols.\n\n**Recommended Solution:** Protocol-based approach (per CLAUDE.md):\n```swift\nprotocol HealthDataProvider {\n    func checkReadAuthorization() async -\u003e Bool\n    func fetchTodayHourlyTotals() async throws -\u003e (data: [HourlyEnergyData], latestSampleTimestamp: Date?)\n    func fetchMoveGoal() async throws -\u003e Double\n    func fetchAverageData(for weekday: Int?) async throws -\u003e (total: Double, hourlyData: [HourlyEnergyData])\n}\n\nfinal class HealthKitQueryService: HealthDataProvider { ... }\nclass MockHealthKitQueryService: HealthDataProvider { ... }\n```\n\n### 4. Documentation: Add Testing section to CLAUDE.md\n**Recommendation:** Add minimal Testing section to CLAUDE.md that points to the comprehensive testing documentation:\n- Brief mention that project has comprehensive test suite\n- Pointer to `HealthTrendsWidgetTests/README.md` for full details\n- Keep CLAUDE.md focused on high-level architecture, defer testing details to README\n**Priority:** Nice to Have (Future PRs)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-19T11:10:14.179867-06:00","updated_at":"2025-12-19T15:20:28.796321-06:00","closed_at":"2025-12-19T15:20:28.796321-06:00","close_reason":"Completed all 4 code review improvements from PR #55","dependencies":[{"issue_id":"HT-h01","depends_on_id":"HT-b5y","type":"blocks","created_at":"2025-12-19T11:10:27.651223-06:00","created_by":"daemon","metadata":"{}"}]}
{"id":"HT-hpz","title":"Bug: Data Time marker rendered off-chart (stale data)","description":"## Problem\nData Time is on the previous day, causing the gray circle marker to render off the left edge of the chart.\n\n**Observed:**\n- Clock time: 2:34 PM\n- Latest sample time: 9:23 PM (likely previous day - ~17 hours old)\n- Today: 0 cal, Average: 0 cal\n- Gray circle marker positioned off-chart to the left\n\n## Expected Behavior\nIf `latestSampleTimestamp` does not exist or is not today's date, the chart should use the current time (or widget timeline entry time) as Data Time and use 0 for Today data.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-16T13:04:27.973767-06:00","updated_at":"2025-12-17T23:53:45.868437-06:00","closed_at":"2025-12-17T23:53:45.868437-06:00","close_reason":"Fixed stale data timestamp handling: Added validation in DailyActiveEnergyWidget.swift to check if latestSampleTimestamp is from today before using it as effectiveDate. If timestamp is from yesterday, falls back to current time. This prevents the gray circle marker from rendering off-chart when data is stale. Fixed in 3 locations: cache fallback path (line 341), fresh HealthKit query path (line 602), and widget gallery path (line 664).","dependencies":[{"issue_id":"HT-hpz","depends_on_id":"HT-35","type":"blocks","created_at":"2025-12-16T13:04:27.978403-06:00","created_by":"daemon","metadata":"{}"}]}
{"id":"HT-wz9","title":"Refactor: Consolidate duplicate EnergyWidgetEntry creation in error paths","description":"## Problem\n\nThe `loadFreshEntry()` function has **5 nearly identical error handling paths** that all create the same empty/unauthorized entry structure:\n\n**Path #6: No cache (lines 454-464)**\n```swift\nreturn EnergyWidgetEntry(\n    date: date,\n    todayTotal: 0,\n    averageAtCurrentHour: 0,\n    projectedTotal: 0,\n    moveGoal: loadCachedMoveGoal(),\n    todayHourlyData: [],\n    averageHourlyData: [],\n    configuration: configuration,\n    isAuthorized: false\n)\n```\n\n**Path #7: Container not found (lines 469-479)**\n```swift\nreturn EnergyWidgetEntry(\n    date: date,\n    todayTotal: 0,\n    averageAtCurrentHour: 0,\n    projectedTotal: 0,\n    moveGoal: loadCachedMoveGoal(),\n    todayHourlyData: [],\n    averageHourlyData: [],\n    configuration: configuration,\n    isAuthorized: false\n)\n```\n\n**Paths #8, #9** (cache corruption, unexpected error) - **Identical structure**\n\nThis duplication:\n- Makes refactoring harder\n- Increases chance of inconsistency if one path changes\n- Adds unnecessary lines of code (5 paths × 12 lines = 60 lines of duplication)\n\n## Proposed Solution\n\nExtract common error entry creation into a helper function:\n\n```swift\nprivate func createErrorEntry(\n    date: Date,\n    configuration: EnergyWidgetConfigurationIntent\n) -\u003e EnergyWidgetEntry {\n    EnergyWidgetEntry(\n        date: date,\n        todayTotal: 0,\n        averageAtCurrentHour: 0,\n        projectedTotal: 0,\n        moveGoal: loadCachedMoveGoal(),\n        todayHourlyData: [],\n        averageHourlyData: [],\n        configuration: configuration,\n        isAuthorized: false\n    )\n}\n```\n\nThen replace all 5 duplicate paths with:\n```swift\n} catch TodayEnergyCacheError.fileNotFound {\n    Self.logger.warning(\"❌ No cache found - returning unauthorized state\")\n    return createErrorEntry(date: date, configuration: configuration)\n}\n\n} catch TodayEnergyCacheError.containerNotFound {\n    Self.logger.error(\"❌ App group container not found - configuration error\")\n    return createErrorEntry(date: date, configuration: configuration)\n}\n\n} catch let error as DecodingError {\n    Self.logger.error(\"❌ Cache corruption: Failed to decode cached data\")\n    Self.logger.error(\"   Error: \\(String(describing: error))\")\n    return createErrorEntry(date: date, configuration: configuration)\n}\n\n} catch {\n    Self.logger.error(\"❌ UNEXPECTED cache error: \\(type(of: error))\")\n    Self.logger.error(\"   Error: \\(error.localizedDescription, privacy: .public)\")\n    return createErrorEntry(date: date, configuration: configuration)\n}\n```\n\n## Benefits\n\n1. **DRY Principle** - Single source of truth for error entry structure\n2. **Easier Maintenance** - Change error entry format in one place\n3. **Better Readability** - Error handling paths focus on logging, not construction\n4. **Reduced LOC** - ~60 lines → ~20 lines\n5. **Easier Testing** - Can test error entry creation independently\n\n## Additional Consolidation Opportunities\n\nReview if **other entry creation paths** share common patterns:\n\n- Success path (lines 655-665)\n- Today's cache fallback (lines 414-426)\n- Yesterday's cache fallback (lines 438-448)\n- Average query failed (lines 584-594)\n- Widget gallery paths (lines 694-706)\n\n**Potential additional helpers:**\n- `createCacheBasedEntry()` - for cache fallback paths?\n- `createAverageOnlyEntry()` - for yesterday's cache/stale scenarios?\n\n## Investigation Tasks\n\n- [ ] Identify all EnergyWidgetEntry creation sites\n- [ ] Group by similarity (parameters, structure)\n- [ ] Determine which consolidations make sense\n- [ ] Ensure consolidation doesn't reduce clarity\n- [ ] Consider: Are 5 error paths different enough to warrant separate functions?\n\n## Why This Matters for HT-12g\n\nHT-12g will add tests for these error paths. **Before writing those tests**, we should:\n1. Consolidate the duplicate code\n2. Tests will then be cleaner (can verify `createErrorEntry()` is called)\n3. Reduces test maintenance burden (fewer entry construction variations to validate)\n\n**Recommendation:** Complete this refactor BEFORE implementing HT-12g tests.\n\n## Files to Modify\n\n- `DailyActiveEnergyWidget/DailyActiveEnergyWidget.swift`\n  - Add `createErrorEntry()` helper\n  - Replace 5 error paths with calls to helper\n  - Consider additional consolidation opportunities\n\n## Success Criteria\n\n- [ ] `createErrorEntry()` helper function created\n- [ ] All 5 error paths use helper\n- [ ] All existing tests still pass (no behavior change)\n- [ ] Code coverage unchanged (refactor only)\n- [ ] ~40-50 lines of code removed\n- [ ] Entry creation logic centralized and maintainable","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T09:33:24.011971-06:00","updated_at":"2025-12-20T09:42:52.952585-06:00","closed_at":"2025-12-20T09:42:52.952585-06:00","close_reason":"Completed: Consolidated 5 duplicate error entry creation paths into createErrorEntry() helper. Reduced code by 35 lines while maintaining all test coverage.","dependencies":[{"issue_id":"HT-wz9","depends_on_id":"HT-9y8","type":"discovered-from","created_at":"2025-12-20T09:33:24.013736-06:00","created_by":"daemon","metadata":"{}"}]}
{"id":"HT-y7k","title":"Refactor widget provider to inject cache managers for better testability","description":"Currently EnergyWidgetProvider creates new instances of AverageDataCacheManager and uses TodayEnergyCacheManager.shared directly. This makes testing harder because:\n\n- Tests must clear actual filesystem caches between runs\n- Tests can interfere with each other if caches aren't cleared properly\n- Slower due to actual file I/O operations\n- Dependencies are implicit (hidden inside methods)\n\nCurrent pattern:\n```swift\nfunc loadFreshEntry(...) {\n    let cacheManager = AverageDataCacheManager()  // Creates new instance\n    try TodayEnergyCacheManager.shared.readEnergyData()  // Uses singleton\n}\n```\n\nTests currently work around this by clearing caches:\n```swift\nAverageDataCacheManager().clearCache()\nTodayEnergyCacheManager.shared.clearCache()\n```\n\n## Proposed Solution\n\nInject cache managers via initializer, similar to how healthKitService is already injected:\n\n```swift\nclass EnergyWidgetProvider: TimelineProvider {\n    let healthKitService: HealthKitQueryService\n    let averageCacheManager: AverageDataCacheManager\n    let todayCacheManager: TodayEnergyCacheManager\n    \n    init(\n        healthKitService: HealthKitQueryService = HealthKitQueryService(),\n        averageCacheManager: AverageDataCacheManager = AverageDataCacheManager(),\n        todayCacheManager: TodayEnergyCacheManager = TodayEnergyCacheManager.shared\n    ) {\n        self.healthKitService = healthKitService\n        self.averageCacheManager = averageCacheManager\n        self.todayCacheManager = todayCacheManager\n    }\n}\n```\n\nThen in tests, inject mock cache managers that return empty/nil without file I/O.\n\n## Acceptance Criteria\n\n- EnergyWidgetProvider accepts cache managers via initializer\n- Default parameters maintain backward compatibility (production code unchanged)\n- All internal uses of cache managers use injected instances instead of creating new ones\n- Tests inject mock cache managers instead of clearing filesystem caches\n- All 34 widget tests still pass","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-19T10:23:26.447724-06:00","updated_at":"2025-12-19T15:45:32.354932-06:00","closed_at":"2025-12-19T15:45:32.354932-06:00","close_reason":"Completed: Cache managers successfully injected via initializer, all tests updated to use mocks, all 12 widget tests passing"}
{"id":"HT-ysa","title":"Optimize HealthKit queries: Use hourly statistics instead of fetching all samples","description":"## Problem\n\nCurrently fetching EVERY individual HealthKit sample and then summing them to hourly totals in our code. This is inefficient:\n\n1. **Overfetching**: Downloading thousands of individual samples when we only need ~24 hourly sums\n2. **Unnecessary computation**: Manually summing samples that HealthKit can aggregate for us\n3. **Performance impact**: More data transfer, more CPU work, slower queries\n4. **Memory overhead**: Holding all samples in memory during aggregation\n\n## Requested Change\n\nUse `HKStatisticsCollectionQuery` to get **pre-aggregated hourly statistics** directly from HealthKit instead of fetching individual samples.\n\n**Current approach:**\n```swift\n// Fetch all samples\nHKSampleQuery(sampleType: activeEnergy, predicate: ...) { samples in\n    // Manually sum samples into hours\n    let hourlyTotals = sumSamplesByHour(samples)\n}\n```\n\n**Better approach:**\n```swift\n// HealthKit aggregates for us\nHKStatisticsCollectionQuery(\n    quantityType: activeEnergy,\n    quantitySamplePredicate: ...,\n    anchorDate: startOfDay,\n    intervalComponents: DateComponents(hour: 1)  // Hourly buckets\n) { statistics in\n    // Already summed by hour - just extract values\n}\n```\n\n## Why This Matters\n\n- **Performance**: 10x-100x less data transferred (24 statistics vs thousands of samples)\n- **Battery**: Less CPU work = better battery life\n- **Widget efficiency**: Faster queries = snappier widget updates\n- **HealthKit best practice**: Use statistics queries for aggregated data\n\n## Expected Outcome\n\nHealthKit queries return hourly sums directly, eliminating manual aggregation logic. Queries complete faster with less data transfer.\n\n## Files Likely Involved\n\n- `HealthTrendsShared/Sources/HealthTrendsShared/HealthKitQueryService.swift` - Replace sample queries with statistics collection queries\n- Any logic that manually sums samples by hour - Remove/simplify\n\n## Implementation Notes\n\n- Use `HKStatisticsCollectionQuery` with `intervalComponents: DateComponents(hour: 1)`\n- Use `.cumulativeSum()` for active energy (cumulative quantity type)\n- Anchor to start of day for consistent hourly boundaries\n- May need to handle edge cases: partial hours, midnight boundaries","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-17T23:48:43.401511-06:00","updated_at":"2025-12-17T23:48:43.401511-06:00"}
